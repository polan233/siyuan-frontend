var mapvgl_1 = require("mapvgl");
const MAX_FRAME = 300;

var BMapGLLib = (window.BMapGLLib = BMapGLLib || {});
(function () {
  var T;
  var baidu = (T = baidu || { version: "1.5.0" });
  baidu.guid = "$BAIDU$";
  (function () {
    window[baidu.guid] = window[baidu.guid] || {};
    baidu.dom = baidu.dom || {};
    baidu.dom.g = function (id) {
      if ("string" == typeof id || id instanceof String) {
        return document.getElementById(id);
      } else {
        if (id && id.nodeName && (id.nodeType == 1 || id.nodeType == 9)) {
          return id;
        }
      }
      return null;
    };
    baidu.g = baidu.G = baidu.dom.g;
    baidu.lang = baidu.lang || {};
    baidu.lang.isString = function (source) {
      return "[object String]" == Object.prototype.toString.call(source);
    };
    baidu.isString = baidu.lang.isString;
    baidu.dom._g = function (id) {
      if (baidu.lang.isString(id)) {
        return document.getElementById(id);
      }
      return id;
    };
    baidu._g = baidu.dom._g;
    baidu.dom.getDocument = function (element) {
      element = baidu.dom.g(element);
      return element.nodeType == 9
        ? element
        : element.ownerDocument || element.document;
    };
    baidu.browser = baidu.browser || {};
    baidu.browser.ie = baidu.ie = /msie (\d+\.\d+)/i.test(navigator.userAgent)
      ? document.documentMode || +RegExp["\x241"]
      : undefined;
    baidu.dom.getComputedStyle = function (element, key) {
      element = baidu.dom._g(element);
      var doc = baidu.dom.getDocument(element),
        styles;
      if (doc.defaultView && doc.defaultView.getComputedStyle) {
        styles = doc.defaultView.getComputedStyle(element, null);
        if (styles) {
          return styles[key] || styles.getPropertyValue(key);
        }
      }
      return "";
    };
    baidu.dom._styleFixer = baidu.dom._styleFixer || {};
    baidu.dom._styleFilter = baidu.dom._styleFilter || [];
    baidu.dom._styleFilter.filter = function (key, value, method) {
      var filters = baidu.dom._styleFilter;
      var filter;
      for (var i = 0; (filter = filters[i]); i++) {
        if ((filter = filter[method])) {
          value = filter(key, value);
        }
      }
      return value;
    };
    baidu.string = baidu.string || {};
    baidu.string.toCamelCase = function (source) {
      if (source.indexOf("-") < 0 && source.indexOf("_") < 0) {
        return source;
      }
      return source.replace(/[-_][^-_]/g, function (match) {
        return match.charAt(1).toUpperCase();
      });
    };
    baidu.dom.getStyle = function (element, key) {
      var dom = baidu.dom;
      element = dom.g(element);
      key = baidu.string.toCamelCase(key);
      var value =
        element.style[key] ||
        (element.currentStyle ? element.currentStyle[key] : "") ||
        dom.getComputedStyle(element, key);
      if (!value) {
        var fixer = dom._styleFixer[key];
        if (fixer) {
          value = fixer.get
            ? fixer.get(element)
            : baidu.dom.getStyle(element, fixer);
        }
      }
      if ((fixer = dom._styleFilter)) {
        value = fixer.filter(key, value, "get");
      }
      return value;
    };
    baidu.getStyle = baidu.dom.getStyle;
    baidu.dom._NAME_ATTRS = (function () {
      var result = {
        cellpadding: "cellPadding",
        cellspacing: "cellSpacing",
        colspan: "colSpan",
        rowspan: "rowSpan",
        valign: "vAlign",
        usemap: "useMap",
        frameborder: "frameBorder",
      };
      if (baidu.browser.ie < 8) {
        result["for"] = "htmlFor";
        result["class"] = "className";
      } else {
        result["htmlFor"] = "for";
        result["className"] = "class";
      }
      return result;
    })();
    baidu.dom.setAttr = function (element, key, value) {
      element = baidu.dom.g(element);
      if ("style" == key) {
        element.style.cssText = value;
      } else {
        key = baidu.dom._NAME_ATTRS[key] || key;
        element.setAttribute(key, value);
      }
      return element;
    };
    baidu.setAttr = baidu.dom.setAttr;
    baidu.dom.setAttrs = function (element, attributes) {
      element = baidu.dom.g(element);
      for (var key in attributes) {
        baidu.dom.setAttr(element, key, attributes[key]);
      }
      return element;
    };
    baidu.setAttrs = baidu.dom.setAttrs;
    baidu.dom.create = function (tagName, opt_attributes) {
      var el = document.createElement(tagName),
        attributes = opt_attributes || {};
      return baidu.dom.setAttrs(el, attributes);
    };
    baidu.object = baidu.object || {};
    baidu.extend = baidu.object.extend = function (target, source) {
      for (var p in source) {
        if (source.hasOwnProperty(p)) {
          target[p] = source[p];
        }
      }
      return target;
    };
  })();
  //NOTE: here may have some tricks
  // MC: mercator , LL: lat & lng
  const WORLD_SIZE_MC_HALF = 20037726.372307256;
  const WORLD_SIZE_MC = WORLD_SIZE_MC_HALF * 2;
  var LuShu = (BMapGLLib.LuShu = function (map, path, opts, speed,pauseTime) {
    // path是点数组,[{lng, lat}]，landmarkPois是要显示的特殊点 [{lng, lat, html, pauseTime}, {lng, lat, html, pauseTime}]
    if (!path || path.length < 1) {
      return;
    }
    this._map = map;
    this.speed = speed;
    this.pauseTime=pauseTime
    if (opts["geodesic"]) {
      this._path = getGeodesicPath(path);
    }
    else if (opts["odCurve"]){  // 是否使用Odcurve
      var lineData = [];
      var curve = new mapvgl_1.OdCurve();
      for(var i = 0 ; i < path.length-1 ; i++){
        var start = path[i];
        var end = path[i+1]; //LL
        curve.setOptions({
          points: [start, end]
        });
        var curveModelData = curve.getPoints(MAX_FRAME-1); //最细
        lineData.push(curveModelData)
      }
      this.lineData = lineData;
      this._path = path; // LL
      // this._path = getGeodesicPath(path);
    }
    else {
      this._path = path;
    } //是否geodesic, 测地线?
    this.i = 0;
    this._setTimeoutQuene = [];
    this._opts = { icon: null, defaultContent: "" };
    // 默认opts
    if (!opts["landmarkPois"]) {
      opts["landmarkPois"] = [];
    }
    this._setOptions(opts);
    this._rotation = 0;
    var fly = "data:image/png;base64,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";
    // var fly = "data:image/png;base64,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"
    if (!(this._opts.icon instanceof window.BMapGL.Icon)) {
      this._opts.icon = new window.BMapGL.Icon(fly, new window.BMapGL.Size(50, 50), {
        anchor: new window.BMapGL.Size(25, 25),
      });
    }
    this.started = false;
  });
  LuShu.prototype._setOptions = function (opts) {
    if (!opts) {
      return;
    }
    for (var p in opts) {
      if (opts.hasOwnProperty(p)) {
        this._opts[p] = opts[p];
      }
    }
  };
  LuShu.prototype.setSpeedAndPauseTime = function(speed,pauseTime){
    var me = this
    me.speed = speed;
    me.pauseTime=pauseTime;
  }
  LuShu.prototype.start = function () {
    var me = this,
      len = me._path.length;// _path is points
    if (me.i && me.i < len - 1) {
      if (!me._fromPause) {
        return;
      } else {
        if (!me._fromStop) {
          me._moveNext(++me.i);
        }
      }
    } else {
      me._addMarker();
      me._timeoutFlag = setTimeout(function () {
        me._addInfoWin();
        if (me._opts.defaultContent == "") {
          me.hideInfoWindow();
        }
        me.started = true;
        me._moveNext(me.i);
      }, 400);
    }
    this._fromPause = false;
    this._fromStop = false;
  };
  LuShu.prototype.stop = function () {
    this.i = 0;
    this._fromStop = true;
    clearInterval(this._intervalFlag);
    this._clearTimeout();
    for (var i = 0, t = this._opts.landmarkPois, len = t.length; i < len; i++) {
      t[i].bShow = false;
    }
    this._overlay._div.style.visibility = "hidden";
  };
  LuShu.prototype.pause = function () {
    clearInterval(this._intervalFlag);
    this._fromPause = true;
    this._clearTimeout();
  };
  LuShu.prototype.hideInfoWindow = function () {
    this._overlay._div.style.visibility = "hidden";
  };
  LuShu.prototype.showInfoWindow = function () {
    this._overlay._div.style.visibility = "visible";
  };
  baidu.object.extend(LuShu.prototype, {
    _addMarker: function (callback) {
      if (this._marker) {
        this.stop();
        this._map.removeOverlay(this._marker);
        clearTimeout(this._timeoutFlag);
      } // 先去除marker
      this._overlay && this._map.removeOverlay(this._overlay);
      var marker = new window.BMapGL.Marker(this._path[0]);
      this._opts.icon && marker.setIcon(this._opts.icon);
      this._map.addOverlay(marker);
      const BMAP_ANIMATION_DROP = window.BMapGL.BMAP_ANIMATION_DROP;
      marker.setAnimation(BMAP_ANIMATION_DROP);
      this._marker = marker;
    },
    _addInfoWin: function () {
      var me = this;
      var overlay = new CustomOverlay(
        me._marker.getPosition(),
        me._opts.defaultContent
      );
      overlay.setRelatedClass(this);
      this._overlay = overlay;
      this._map.addOverlay(overlay);
    },
    _getMercator: function (poi) {
      return this._map.getMapType().getProjection().lngLatToPoint(poi);
    },
    _getDistance: function (pxA, pxB) {
      return Math.sqrt(Math.pow(pxA.x - pxB.x, 2) + Math.pow(pxA.y - pxB.y, 2));
    },
    // 如何移动
    _move: function (initPos, targetPos, effect, i) {
      var me = this,
        currentCount = 0,
        currentPos = initPos,
        timer = 10,                              // timer: 
        // step = this._opts.speed / (1000 / timer),//NOTE: timer
        init_pos = window.BMapGL.Projection.convertLL2MC(initPos),
        target_pos = window.BMapGL.Projection.convertLL2MC(targetPos);
      init_pos = new window.BMapGL.Pixel(init_pos.lng, init_pos.lat);
      target_pos = new window.BMapGL.Pixel(target_pos.lng, target_pos.lat);
      //转换坐标
      var mcDis = me._getDistance(init_pos, target_pos);

      var direction = null;
      if (mcDis > 30037726) {  //半球转换相关
        if (target_pos.x < init_pos.x) {
          target_pos.x += WORLD_SIZE_MC;
          direction = "right";
        } else {
          target_pos.x -= WORLD_SIZE_MC;
          direction = "left";
        }
      }// 确定方向
      // var count = Math.round(me._getDistance(init_pos, target_pos) / step);// count是每段的帧数
      // var count = timer * opts[speed]  //150帧, 1.5s
      if (me.speed < 1) {
        me._moveNext(++me.i);
        return;
      }
      me._intervalFlag = setInterval(function () {
        if (currentCount >= me.speed) {
          clearInterval(me._intervalFlag);
          if (me.i > me._path.length) {
            return;
          }
          me._moveNext(++me.i);
        } else {
          currentCount++; // 下一帧
          // effect确定下一步如何走
          // var x = effect(init_pos.x, target_pos.x, currentCount, me.speed, "x"),
          //   y = effect(init_pos.y, target_pos.y, currentCount, me.speed, "y"),
          var nextPoint = effect(currentCount, me.speed, me.lineData, i);
          var x = nextPoint[0],
            y = nextPoint[1],
            pos = window.BMapGL.Projection.convertMC2LL(new window.BMapGL.Point(x, y));
            // pos = new window.BMapGL.Point(x, y);
          if (pos.lng > 180) {
            pos.lng = pos.lng - 360;
          }
          if (pos.lng < -180) {
            pos.lng = pos.lng + 360;
          }
          if (currentCount == 1) {
            var prePos = null;
            if (me.i - 1 >= 0) {
              prePos = me._path[me.i - 1]; //LL
            }
            if (me._opts.autoView) {
              if (!me._map.getBounds().containsPoint(pos)) {
                me._map.setCenter(pos);
              }
            }
            if (me._opts.autoCenterAndZoom) {
                
                if((Math.abs(initPos.lng-targetPos.lng)>=0.5)||(Math.abs(initPos.lat-targetPos.lat)>=0.5)){
                  var res = me._map.getViewport([initPos, targetPos]);
                  me._map.centerAndZoom(res.center, res.zoom);
                }
            }
          }
          if (me._opts.autoCenter) {
            me._map.setCenter(pos, { noAnimation: true });
          }
          if (me._opts.enableRotation == true) {
            let d=1.1;
            // console.log("setRotation",currentPos,pos)
            if((currentPos.lng==initPos.lng&&currentPos.lat==initPos.lat)
            &&((Math.abs(currentPos.lng-pos.lng)>=0.1)||(Math.abs(currentPos.lat-pos.lat)>=0.1))){
              me.setRotation(prePos, currentPos, targetPos, direction);
            }
            if((Math.abs(currentPos.lng-pos.lng)>=1.1)||(Math.abs(currentPos.lat-pos.lat)>=1.1)){ //防止两点相同或差距过小导致飞机乱转
              me.setRotation(prePos, currentPos, pos, direction);
              currentPos = pos;
            }
          }
          me._marker.setPosition(pos); // 运动
          me._setInfoWin(pos);
        }
      }, timer);
    },
    setRotation: function (prePos, curPos, targetPos, direction) {
      var me = this;
      var deg = 0;
      curPos = me._map.pointToPixel(curPos);
      targetPos = me._map.pointToPixel(targetPos);
      if (targetPos.x != curPos.x) {
        var tan = (targetPos.y - curPos.y) / (targetPos.x - curPos.x),
          atan = Math.atan(tan);
        deg = (atan * 360) / (2 * Math.PI);
        if ((!direction && targetPos.x < curPos.x) || direction === "left") {
          deg = -deg + 90 + 90;
        } else {
          deg = -deg;
        }
        me._marker.setRotation(-deg);
      } else {
        var disy = targetPos.y - curPos.y;
        var bias = 0;
        if (disy > 0) {
          bias = -1;
        } else {
          bias = 1;
        }
        me._marker.setRotation(-bias * 90);
      }
      return;
    },
    linePixellength: function (from, to) {
      return Math.sqrt(
        Math.abs(from.x - to.x) * Math.abs(from.x - to.x) +
          Math.abs(from.y - to.y) * Math.abs(from.y - to.y)
      );
    },
    pointToPoint: function (from, to) {
      return (
        Math.abs(from.x - to.x) * Math.abs(from.x - to.x) +
        Math.abs(from.y - to.y) * Math.abs(from.y - to.y)
      );
    },
    _moveNext: function (index) {
      // index indicates the points TODO
      var me = this;
      if (index < this._path.length - 1) {
        // me._move(me._path[index], me._path[index + 1], me._tween.linear);
        me._move(me._path[index], me._path[index + 1], me._tween.OdCurve, me.i);
      }
      else {
        if (this._marker) {
          this.stop();
          this._map.removeOverlay(this._marker);
          clearTimeout(this._timeoutFlag);
        }
      }
    },
    _setInfoWin: function (pos) {
      var me = this;
      if (!me._overlay) {
        return;
      }
      me._overlay.setPosition(pos, me._marker.getIcon().size);
      var index = me._troughPointIndex(pos);
      if (index != -1) {
        clearInterval(me._intervalFlag);
        me._map.centerAndZoom(pos, 6);
        me._overlay.setHtml(me._opts.landmarkPois[index].html);
        me._overlay.setPosition(pos, me._marker.getIcon().size);
        me._pauseForView(index);
      } else {
        me._overlay.setHtml(me._opts.defaultContent);
      }
    },
    _pauseForView: function (index) {
      var me = this;
      var t = setTimeout(function () {
        me._moveNext(++me.i);
      }, me.pauseTime * 1000);
      me._setTimeoutQuene.push(t);
    },
    _clearTimeout: function () {
      for (var i in this._setTimeoutQuene) {
        clearTimeout(this._setTimeoutQuene[i]);
      }
      this._setTimeoutQuene.length = 0;
    },
    // TODO: 完成类ARC轨迹
    _tween: {
      linear: function (initPos, targetPos, currentCount, count) {
        var b = initPos;
        var c = targetPos - initPos;
        var t = currentCount;
        var d = count;
        return (c * t) / d + b;
      },
      OdCurve: function (currentCount, count, lineData, i) {
        var lineDataArrayIndex = Math.round(MAX_FRAME*currentCount/count)
        return lineData[i][lineDataArrayIndex>=MAX_FRAME?MAX_FRAME-1:lineDataArrayIndex]
      }
    },
    _troughPointIndex: function (markerPoi) {
      var t = this._opts.landmarkPois;
      var distance;
      for (var i = 0, len = t.length; i < len; i++) {
        if (!t[i].bShow) {
          distance = this._map.getDistance(
            new window.BMapGL.Point(t[i].lng, t[i].lat),
            markerPoi
          );
          if (distance < 10) {
            t[i].bShow = true;
            return i;
          }
        }
      }
      return -1;
    },
  });
  // 不使用geodesic, 所以不用管
  function getGeodesicPath(points) {
    var gPath = [];
    for (var i = 0; i < points.length - 1; i++) {
      var great = calcGreatCirclePath(points[i], points[i + 1]);
      gPath = gPath.concat(great);
    }
    gPath = gPath.concat(points[points.length - 1]);
    return gPath;
  }
  function calcGreatCirclePath(latLng1, latLng2) {
    if (latLng1.equals(latLng2)) {
      return [latLng1];
    }
    var distance = window.BMapGL.Projection.getDistance(
      toRadian(latLng1.lng),
      toRadian(latLng1.lat),
      toRadian(latLng2.lng),
      toRadian(latLng2.lat)
    );
    var distance = window.BMapGL.Projection.getDistanceByLL(latLng1, latLng2);
    if (distance < 250000) {
      return [latLng1];
    }
    var result = [];
    var count = Math.round(distance / 150000);
    var angularDistance = calcAngularDistance(latLng1, latLng2);
    result.push(latLng1);
    for (var i = 0; i < count; i++) {
      var eachLatLng = calcMiddlePoint(
        latLng1,
        latLng2,
        i / count,
        angularDistance
      );
      result.push(eachLatLng);
    }
    result.push(latLng2);
    return result;
  }
  function calcMiddlePoint(latLng1, latLng2, f, delta) {
    var lat1 = latLng1.lat;
    var lat2 = latLng2.lat;
    var lon1 = latLng1.lng;
    var lon2 = latLng2.lng;
    var phi1 = toRadian(lat1);
    var phi2 = toRadian(lat2);
    var lambda1 = toRadian(lon1);
    var lambda2 = toRadian(lon2);
    var a = Math.sin((1 - f) * delta) / Math.sin(delta);
    var b = Math.sin(f * delta) / Math.sin(delta);
    var x =
      a * Math.cos(phi1) * Math.cos(lambda1) +
      b * Math.cos(phi2) * Math.cos(lambda2);
    var y =
      a * Math.cos(phi1) * Math.sin(lambda1) +
      b * Math.cos(phi2) * Math.sin(lambda2);
    var z = a * Math.sin(phi1) + b * Math.sin(phi2);
    var phi = Math.atan2(z, Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2)));
    var lambda = Math.atan2(y, x);
    return new window.BMapGL.Point(toAngle(lambda), toAngle(phi));
  }
  function toRadian(angle) {
    return (angle * Math.PI) / 180;
  }
  function toAngle(radian) {
    return (radian / Math.PI) * 180;
  }
  function calcAngularDistance(latLng1, latLng2) {
    var lat1 = toRadian(latLng1.lat);
    var lat2 = toRadian(latLng2.lat);
    var lng1 = toRadian(latLng1.lng);
    var lng2 = toRadian(latLng2.lng);
    return Math.acos(
      Math.sin(lat1) * Math.sin(lat2) +
        Math.cos(lat1) * Math.cos(lat2) * Math.cos(Math.abs(lng2 - lng1))
    );
  }
  function CustomOverlay(point, html) {
    this._point = point;
    this._html = html;
  }
  CustomOverlay.prototype = new window.BMapGL.Overlay();
  CustomOverlay.prototype.initialize = function (map) {
    var div = (this._div = baidu.dom.create("div", {
      style:
        "border:solid 1px #ccc;width:auto;min-width:50px;text-align:center;position:absolute;background:#fff;color:#000;font-size:12px;border-radius: 10px;padding:5px;white-space: nowrap;",
    }));
    div.innerHTML = this._html;
    map.getPanes().floatPane.appendChild(div);
    this._map = map;
  };
  CustomOverlay.prototype.draw = function () {
    this.setPosition(
      this.lushuMain._marker.getPosition(),
      this.lushuMain._marker.getIcon().size
    );
  };
  baidu.object.extend(CustomOverlay.prototype, {
    setPosition: function (poi, markerSize) {
      var px = this._map.pointToOverlayPixel(poi);
      var styleW = baidu.dom.getStyle(this._div, "width");
      var styleH = baidu.dom.getStyle(this._div, "height");
      var overlayW = parseInt(this._div.clientWidth || styleW, 10);
      var overlayH = parseInt(this._div.clientHeight || styleH, 10);
      this._div.style.left = px.x - overlayW / 2 + "px";
      this._div.style.bottom = -(px.y - markerSize.height) + "px";
    },
    setHtml: function (html) {
      this._div.innerHTML = html;
    },
    setRelatedClass: function (lushuMain) {
      this.lushuMain = lushuMain;
    },
  });
})();
